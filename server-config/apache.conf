<VirtualHost *:80>
    ServerName adarabliss.com
    ServerAlias www.adarabliss.com
    
    # Redirigir todo el tráfico HTTP a HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName adarabliss.com
    ServerAlias www.adarabliss.com
    DocumentRoot /var/www/adarabliss/dist
    
    # Certificados SSL
    SSLEngine on
    SSLCertificateFile ${SSL_CERTIFICATE}
    SSLCertificateKeyFile ${SSL_PRIVATE_KEY}
    
    # Configuración de seguridad SSL
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # Headers de seguridad
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Configuración del frontend (React/Vite)
    <Directory /var/www/adarabliss/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Rewrite para SPA
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
        
        # Cache para archivos estáticos
        <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js)$">
            Header set Cache-Control "max-age=31536000, public"
        </FilesMatch>
    </Directory>
    
    # Configuración de la API
    Alias /api /var/www/adarabliss/api
    <Directory /var/www/adarabliss/api>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Prevenir acceso a archivos sensibles
        <FilesMatch "^\.">
            Order allow,deny
            Deny from all
        </FilesMatch>
        
        <FilesMatch "\.(?:env|json|config.php|sql)$">
            Order allow,deny
            Deny from all
        </FilesMatch>
    </Directory>
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/adarabliss-error.log
    CustomLog ${APACHE_LOG_DIR}/adarabliss-access.log combined
    
    # PHP-FPM Configuration
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost"
    </FilesMatch>
</VirtualHost>
